@model PomodoroPlant.Models.SessionStats
@{
  ViewData["Title"] = "Analytics";
}

<div class="garden-page">
  <main class="garden-main" aria-label="Analytics view">
    <section class="garden-header">
      <h1 class="garden-title text-center">Your Growth Stats</h1>
      <p class="plant-status text-center" id="label">
        Track your productivity journey and watch your garden flourish!
      </p>

      <!-- Stats Cards -->
      <div class="analytics-cards">
        <!-- Total Focus Hours -->
        <div class="analytics-card">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
            stroke="currentColor" class="analytics-icon">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
          </svg>
          @{
            var totalMinutes = (int)Math.Round(Model.TotalFocusHours * 60);
            string displayValue;
            string displayUnit;

            if (totalMinutes == 0)
            {
              displayValue = "0";
              displayUnit = "Minutes";
            }
            else if (totalMinutes < 60)
            {
              displayValue = totalMinutes.ToString();
              displayUnit = totalMinutes == 1 ? "Minute Focused" : "Minutes Focused";
            }
            else if (totalMinutes < 120)
            {
              var h = totalMinutes / 60;
              var m = totalMinutes % 60;
              displayValue = m == 0 ? h.ToString() : $"{h}h {m}m";
              displayUnit = m == 0 ? "Hour" : "Total Time";
            }
            else if (Model.TotalFocusHours < 10)
            {
              displayValue = Model.TotalFocusHours.ToString("0.0", System.Globalization.CultureInfo.InvariantCulture);
              displayUnit = "Hours Focused";
            }
            else
            {
              displayValue = Math.Round(Model.TotalFocusHours).ToString();
              displayUnit = "Hours Focused";
            }
          }
          <h2 class="analytics-value">@displayValue</h2>
          <h3 class="analytics-title">@displayUnit</h3>
        </div>

        <!-- Active Days -->
        <div class="analytics-card">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
            stroke="currentColor" class="analytics-icon">
            <path stroke-linecap="round" stroke-linejoin="round"
              d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 0 1 2.25-2.25h13.5A2.25 2.25 0 0 1 21 7.5v11.25m-18 0A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75m-18 0v-7.5A2.25 2.25 0 0 1 5.25 9h13.5A2.25 2.25 0 0 1 21 11.25v7.5" />
          </svg>
          <h2 class="analytics-value">@Model.ActiveDays</h2>
          <h3 class="analytics-title">@(Model.ActiveDays == 1 ? "Day" : "Days") Accessed</h3>
        </div>

        <!-- Day Streak -->
        <div class="analytics-card analytics-card--highlight">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
            stroke="currentColor" class="analytics-icon">
            <path stroke-linecap="round" stroke-linejoin="round"
              d="M15.362 5.214A8.252 8.252 0 0 1 12 21 8.25 8.25 0 0 1 6.038 7.047 8.287 8.287 0 0 0 9 9.601a8.983 8.983 0 0 1 3.361-6.867 8.21 8.21 0 0 0 3 2.48Z" />
            <path stroke-linecap="round" stroke-linejoin="round"
              d="M12 18a3.75 3.75 0 0 0 .495-7.468 5.99 5.99 0 0 0-1.925 3.547 5.975 5.975 0 0 1-2.133-1.001A3.75 3.75 0 0 0 12 18Z" />
          </svg>
          <h2 class="analytics-value">@Model.DayStreak</h2>
          <h3 class="analytics-title">@(Model.DayStreak == 1 ? "Day" : "Days") Streak</h3>
        </div>
      </div>

      <!-- Additional Stats -->
      <div class="analytics-secondary-stats">
        <div class="analytics-stat-item">
          <span class="analytics-stat-label">Total Sessions</span>
          <span class="analytics-stat-value">@Model.TotalSessions</span>
        </div>
        <div class="analytics-stat-item">
          <span class="analytics-stat-label">Plants Unlocked</span>
          <span class="analytics-stat-value">@Model.PlantsUnlocked</span>
        </div>
        <div class="analytics-stat-item">
          <span class="analytics-stat-label">Average Session</span>
          <span class="analytics-stat-value">
            @{
              var avg = Model.AverageSessionMinutes; // this should be in MINUTES
              if (avg <= 0)
              {
                @:0 min
              }
              else if (avg < 1)
              {
                // show seconds if average is less than a minute
                var seconds = (int)Math.Round(avg * 60);
                if (seconds == 0) seconds = 1; // avoid showing 0 sec for tiny non-zero values
                                               @seconds <text> sec</text>
              }
              else if (avg < 60)
              {
                var avgRounded = (int)Math.Round(avg);
                @avgRounded <text> min</text>
              }
              else
              {
                var avgTotalMinutes = (int)Math.Round(avg);
                var h = avgTotalMinutes / 60;
                var m = avgTotalMinutes % 60;

                if (m == 0)
                {
                  @h <text> hrs</text>
                }
                else
                {
                  @h <text>h </text>
                  @m <text>m</text>
                }
              }
            }
          </span>
        </div>


        <!-- Weekly Activity Chart (dynamic from model) -->
        <div class="analytics-container">
          <div class="analytics-top-bar">
            <h2 class="analytics-section-title">Focus Activity</h2>
            <div class="analytics-timeframe-selector">
              <button class="analytics-timeframe-button analytics-timeframe-button--active">This Week</button>
              <button class="analytics-timeframe-button">Last Week</button>
              <button class="analytics-timeframe-button">This Month</button>
            </div>
          </div>
          <div class="analytics-chart">
            <div class="analytics-bar-group">
              <div class="analytics-bar">
                <span class="analytics-bar-tooltip"></span>
              </div>
              <span class="analytics-bar-label"></span>
            </div>
            <div class="analytics-bar-group">
              <div class="analytics-bar">
                <span class="analytics-bar-tooltip"></span>
              </div>
              <span class="analytics-bar-label"></span>
            </div>
            <div class="analytics-bar-group">
              <div class="analytics-bar">
                <span class="analytics-bar-tooltip"></span>
              </div>
              <span class="analytics-bar-label"></span>
            </div>
            <div class="analytics-bar-group">
              <div class="analytics-bar">
                <span class="analytics-bar-tooltip"></span>
              </div>
              <span class="analytics-bar-label"></span>
            </div>
            <div class="analytics-bar-group">
              <div class="analytics-bar">
                <span class="analytics-bar-tooltip"></span>
              </div>
              <span class="analytics-bar-label"></span>
            </div>
            <div class="analytics-bar-group">
              <div class="analytics-bar">
                <span class="analytics-bar-tooltip"></span>
              </div>
              <span class="analytics-bar-label"></span>
            </div>
            <div class="analytics-bar-group">
              <div class="analytics-bar">
                <span class="analytics-bar-tooltip"></span>
              </div>
              <span class="analytics-bar-label"></span>
            </div>
          </div>
          <div class="analytics-chart-legend">
            <span class="analytics-legend-label" id="chart-legend-text">Time per day</span>
          </div>
        </div>

        <!-- Recent Achievements (dynamic) -->
        <div class="analytics-achievements">
          <h2 class="analytics-section-title">Recent Milestones</h2>

          @if (Model.Achievements != null && Model.Achievements.Count > 0)
          {
            <div class="achievement-list">
              @foreach (var achievement in Model.Achievements)
              {
                <div class="achievement-item">
                  <div class="achievement-icon">
                    @if (achievement.IconType == "plant")
                    {
                      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" width="24" height="24"
                        stroke-width="1.5" stroke="#fff">
                        <path stroke-linecap="round" stroke-linejoin="round"
                          d="M15.59 14.37a6 6 0 0 1-5.84 7.38v-4.8m5.84-2.58a14.98 14.98 0 0 0 6.16-12.12A14.98 14.98 0 0 0 9.631 8.41m5.96 5.96a14.926 14.926 0 0 1-5.841 2.58m-.119-8.54a6 6 0 0 0-7.381 5.84h4.8m2.581-5.84a14.927 14.927 0 0 0-2.58 5.84m2.699 2.7c-.103.021-.207.041-.311.06a15.09 15.09 0 0 1-2.448-2.448 14.9 14.9 0 0 1 .06-.312m-2.24 2.39a4.493 4.493 0 0 0-1.757 4.306 4.493 4.493 0 0 0 4.306-1.758M16.5 9a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0Z" />
                      </svg>
                    }
                    else if (achievement.IconType == "clock")
                    {
                      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" width="24" height="24" fill="#fff">
                        <path
                          d="M466.6 114.2C461.2 115.9 455.3 116 450.4 113.3C444.6 110.1 438.6 107.1 432.6 104.4C422.2 99.7 418.9 86.1 428.5 79.8C443.5 69.9 461.5 64.1 480.8 64.1C533.4 64.1 576 106.7 576 159.3C576 172.5 573.3 185.1 568.4 196.6C563.9 207.1 550 206.4 543.5 197C539.7 191.5 535.7 186.2 531.5 181C528 176.6 527 170.8 527.7 165.2C527.9 163.3 528.1 161.3 528.1 159.3C528.1 133.2 506.9 112.1 480.9 112.1C476 112.1 471.2 112.9 466.7 114.3zM96.5 196.9C90 206.3 76 207 71.6 196.5C66.7 185 64 172.4 64 159.2C64 106.6 106.6 64 159.2 64C178.5 64 196.5 69.8 211.5 79.7C221.1 86 217.8 99.6 207.4 104.3C201.3 107.1 195.4 110 189.6 113.2C184.7 115.9 178.7 115.8 173.4 114.1C168.9 112.7 164.2 111.9 159.2 111.9C133.1 111.9 112 133.1 112 159.1C112 161.1 112.1 163.1 112.4 165C113.1 170.6 112.1 176.4 108.6 180.8C104.4 186 100.4 191.3 96.6 196.8zM496 352C496 254.8 417.2 176 320 176C222.8 176 144 254.8 144 352C144 449.2 222.8 528 320 528C417.2 528 496 449.2 496 352zM460.5 526.5C422.1 557.4 373.2 576 320 576C266.8 576 217.9 557.4 179.5 526.5L137 569C127.6 578.4 112.4 578.4 103.1 569C93.8 559.6 93.7 544.4 103.1 535.1L145.6 492.6C114.6 454.1 96 405.2 96 352C96 228.3 196.3 128 320 128C443.7 128 544 228.3 544 352C544 405.2 525.4 454.1 494.5 492.5L537 535C546.4 544.4 546.4 559.6 537 568.9C527.6 578.2 512.4 578.3 503.1 568.9L460.6 526.4zM344 248L344 342.1L385 383.1C394.4 392.5 394.4 407.7 385 417C375.6 426.3 360.4 426.4 351.1 417L303.1 369C298.6 364.5 296.1 358.4 296.1 352L296.1 248C296.1 234.7 306.8 224 320.1 224C333.4 224 344.1 234.7 344.1 248z" />
                      </svg>
                    }
                    else if (achievement.IconType == "fire")
                    {
                      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="#fff"
                        width="24" height="24">
                        <path stroke-linecap="round" stroke-linejoin="round"
                          d="M15.362 5.214A8.252 8.252 0 0 1 12 21 8.25 8.25 0 0 1 6.038 7.047 8.287 8.287 0 0 0 9 9.601a8.983 8.983 0 0 1 3.361-6.867 8.21 8.21 0 0 0 3 2.48Z" />
                        <path stroke-linecap="round" stroke-linejoin="round"
                          d="M12 18a3.75 3.75 0 0 0 .495-7.468 5.99 5.99 0 0 0-1.925 3.547 5.975 5.975 0 0 1-2.133-1.001A3.75 3.75 0 0 0 12 18Z" />
                      </svg>
                    }
                  </div>
                  <div class="achievement-content">
                    <h4 class="achievement-title">@achievement.Title</h4>
                    <p class="achievement-date">@achievement.WhenText</p>
                    @if (!string.IsNullOrWhiteSpace(achievement.Description))
                    {
                      <p class="achievement-description">@achievement.Description</p>
                    }
                  </div>
                </div>
              }
            </div>
          }
          else
          {
            <p class="plant-status text-start text-white pb-4">
              Complete focus sessions to unlock your first achievements!
            </p>
          }
        </div>



        <!-- Leaderboard -->
        <div class="leaderboard analytics-achievements">
          <h2 class="analytics-section-title">
            The Leaderboard
          </h2>
          @if (Model.TopUsers != null)
          {
            <div class="achievement-list">
              @{
                var currentUserId = Context.Session.GetInt32("UserId");
              }
              @foreach (var user in Model.TopUsers)
              {
                var isCurrentUser = currentUserId.HasValue && user.UserId == currentUserId.Value;
                var itemClass = isCurrentUser ? "achievement-item achievement-item--highlight" : "achievement-item";

                <div class="@itemClass">
                  <div class="achievement-icon">
                    @if (user.Rank == 1)
                    {
                      <span style="font-size: 1.5rem;">ðŸ¥‡</span>
                    }
                    else if (user.Rank == 2)
                    {
                      <span style="font-size: 1.5rem;">ðŸ¥ˆ</span>
                    }
                    else if (user.Rank == 3)
                    {
                      <span style="font-size: 1.5rem;">ðŸ¥‰</span>
                    }
                    else
                    {
                      <span style="font-size: 1.2rem; font-weight: bold; color: #fff;">@user.Rank</span>
                    }
                  </div>
                  <div class="achievement-content">

                    <h4 class="achievement-title">
                      @user.Name
                      @if (isCurrentUser)
                      {
                        <span style="color: #dc3545; font-size: 0.9rem;">(You)</span>
                      }
                    </h4>
                    @{
                      var userTotalMinutes = (int)Math.Round(user.TotalHours * 60);
                    }
                    @if (userTotalMinutes == 0)
                    {
                      <p class="achievement-date">No focus time yet</p>
                    }
                    else if (userTotalMinutes < 60)
                    {
                      <p class="achievement-date">@userTotalMinutes @(userTotalMinutes == 1 ? "minute" : "minutes") focused
                      </p>
                    }
                    else if (userTotalMinutes < 120)
                    {
                      var h = userTotalMinutes / 60;
                      var m = userTotalMinutes % 60;
                      if (m == 0)
                      {
                        <p class="achievement-date">1 hour focused</p>
                      }
                      else
                      {
                        <p class="achievement-date">1 hour @m minutes focused</p>
                      }
                    }
                    else
                    {
                      var hours = (int)Math.Floor(user.TotalHours);
                      var minutes = (int)Math.Round((user.TotalHours - hours) * 60);
                      if (minutes == 0)
                      {
                        <p class="achievement-date">@hours @(hours == 1 ? "hour" : "hours") focused</p>
                      }
                      else
                      {
                        <p class="achievement-date">@hours @(hours == 1 ? "hour" : "hours") @minutes @(minutes == 1 ? "minute" :
                                            "minutes") focused</p>
                      }
                    }
                  </div>
                </div>
              }
            </div>
          }
          else
          {
            <p class="plant-status text-start text-white pb-4">
              Be the first to start focusing and claim the top spot!
            </p>
          }
        </div>

    </section>
  </main>
</div>

@{
  var thisWeekJson = System.Text.Json.JsonSerializer.Serialize(Model.ThisWeek);
  var lastWeekJson = System.Text.Json.JsonSerializer.Serialize(Model.LastWeek);
  var thisMonthJson = System.Text.Json.JsonSerializer.Serialize(Model.ThisMonth);
}

<script>
  const analyticsData = {
    "This Week": @Html.Raw(thisWeekJson),
    "Last Week": @Html.Raw(lastWeekJson),
    "This Month": @Html.Raw(thisMonthJson)
  };

  document.addEventListener('DOMContentLoaded', function () {
    const timeframeButtons = document.querySelectorAll('.analytics-timeframe-button');
    const barGroups = document.querySelectorAll('.analytics-bar-group');

    timeframeButtons.forEach(button => {
      button.addEventListener('click', function () {
        timeframeButtons.forEach(btn => btn.classList.remove('analytics-timeframe-button--active'));
        this.classList.add('analytics-timeframe-button--active');

        const timeframe = this.textContent.trim();
        updateChart(timeframe, barGroups);
      });
    });

    updateChart("This Week", barGroups);
  });

  function formatTime(hours) {
    if (hours === 0) return '0 min';

    const totalMinutes = Math.round(hours * 60);

    if (totalMinutes === 0) {
      return '0 min';
    }

    if (totalMinutes < 60) {
      return totalMinutes + ' min';
    }

    const h = Math.floor(totalMinutes / 60);
    const m = totalMinutes % 60;

    if (m === 0) {
      return h === 1 ? '1 hr' : h + ' hrs';
    }

    return h + 'h ' + m + 'm';
  }

  function updateChart(timeframe, barGroups) {
    const data = analyticsData[timeframe] || [];
    const legendText = document.getElementById('chart-legend-text');

    if (data.length === 0) {
      barGroups.forEach(g => g.style.display = 'none');
      if (legendText) legendText.textContent = 'No activity yet';
      return;
    }

    if (legendText) {
      legendText.textContent = timeframe === "This Month" ? 'Time per week' : 'Time per day';
    }

    // Fixed maximum scale based on timeframe
    let maxScale;
    if (timeframe === "This Month") {
      maxScale = 16;
    } else {
      maxScale = 4;
    }

    // Use the actual max if it exceeds our fixed scale
    const actualMax = Math.max(...data.map(d => d.Hours || 0));
    const maxHours = Math.max(actualMax, maxScale);

    barGroups.forEach((group, index) => {
      const bar = group.querySelector('.analytics-bar');
      const tooltip = group.querySelector('.analytics-bar-tooltip');
      const label = group.querySelector('.analytics-bar-label');

      if (index >= data.length) {
        group.style.display = 'none';
        return;
      }

      const item = data[index];
      group.style.display = 'flex';

      const heightPercent = Math.max((item.Hours / maxHours) * 100, 2);
      bar.style.height = heightPercent + '%';
      tooltip.textContent = formatTime(item.Hours || 0);
      label.textContent = item.Label;
    });
  }
</script>